extends layout

block content
    .container: .row
        .col-xs-12.col-sm-4.col-sm-offset-4.col-md-2.col-md-offset-5.text-center
            form(action='/auth/login', method='post', role='form')
                input(type='hidden', name='_csrf', value=csrfToken)
                .form-group
                    label(for='username') Brukernavn:
                    input(name='username', type='text', class='form-control')
                .form-group
                    label(for='password') Passord:
                    input(name='password', type='password', class='form-control')
                
                input(name='usingToken', class='hidden', value='false')
                if feedback
                    p= feedback

                div(class="hidden", id="alertInfo")
                    div(class="alert alert-info")
                        h5 Velkommen til VOTE
                        p Du har nå fått bruker, og er nesten klar til å logge inn.
                        p 
                            span Før du logger inn, må du laste ned en kopi av innloggingsinformasjonenen din 
                            span sånn at du kan logge inn på andre enheter, eller hvis du blir logget ut.

                        
                button(class='btn btn-default', type='submit') Logg på

            a(href="" id="download" class="hidden")
                button(class='btn btn-default' ) Last ned kopi

    script.
        if ('addEventListener' in document) {
            document.addEventListener('DOMContentLoaded', function() {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                if (!token) return;

                try {
                    const [u, p, code] = token.split(":");
                    document.querySelector('[name=password]').value=p;
                    document.querySelector('[name=password]').parentElement.style.display="none";

                    document.querySelector('#alertInfo').setAttribute("class","");

                    document.querySelector('[name=usingToken]').value=true;

                    document.querySelector('[name=username]').value=u;
                    document.querySelector('[name=username]').setAttribute("readonly", "readonly");

                    document.querySelector('[type=submit]').style.display="none";

                    document.querySelector('[id=download]').setAttribute("class","");
                    document.querySelector('[id=download]').setAttribute("href","/api/qr/download-file/?token="+token);
                    document.querySelector('[id=download]').onclick = function(e){
                        e.target.setAttribute("class", "hidden");
                        document.querySelector('[type=submit]').style.display="";
                    };

                    fetch("/api/qr/open/?code="+code);
                } catch(e) {
                    console.warn("Unable to decode token: ",e);
                }
            });
        }
